<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿宏推荐系统</title>
    <style>
        /* 原有样式保持不变，新增以下样式 */
        .update-indicator {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            display: inline-block;
        }
        .new-update {
            background-color: #ff4d4f;
            color: white;
            animation: pulse 1.5s infinite;
        }
        .cached-data {
            background-color: #faad14;
            color: white;
        }
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <!-- 原有HTML结构保持不变 -->
    <div class="app-container">
        <!-- ...其他元素... -->
        <div id="recommendationSection" class="recommendation-container">
            <div class="recommendation-title">
                <span class="recommendation-icon">✨</span>
                <span>今日精准推荐</span>
                <span id="updateIndicator" class="update-indicator"></span>
            </div>
            <!-- ... -->
        </div>
    </div>

    <script>
        // 增强版系统配置
        const CONFIG = {
            source: {
                url: "https://cdn.jsdelivr.net/gh/mianyang121403/ahtj1214@main/recommendation.txt",
                // 添加ETag支持
                useETag: true,
                // 强制刷新参数
                forceRefresh: true
            },
            timeout: 10000, // 10秒超时
            cache: {
                enabled: true,
                duration: 300000, // 5分钟缓存
                staleWhileRevalidate: 60000 // 1分钟内使用缓存同时后台更新
            },
            updateCheck: {
                interval: 30000, // 每30秒检查一次
                retry: 3 // 失败重试次数
            }
        };

        // 状态管理
        const appState = {
            lastContent: null,
            lastETag: null,
            lastModified: null,
            isFetching: false
        };

        // 增强的fetch函数
        async function fetchContent() {
            if (appState.isFetching) return;
            appState.isFetching = true;
            
            try {
                const headers = {};
                if (CONFIG.source.useETag && appState.lastETag) {
                    headers['If-None-Match'] = appState.lastETag;
                }
                
                let url = CONFIG.source.url;
                if (CONFIG.source.forceRefresh) {
                    url += (url.includes('?') ? '&' : '?') + '_=' + Date.now();
                }

                const response = await Promise.race([
                    fetch(url, {
                        headers,
                        cache: 'no-cache'
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('请求超时')), CONFIG.timeout)
                ]);

                // 处理304 Not Modified
                if (response.status === 304) {
                    return {
                        status: 'cached',
                        content: appState.lastContent,
                        isModified: false
                    };
                }

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                // 获取新的ETag和Last-Modified
                const eTag = response.headers.get('ETag');
                const lastModified = response.headers.get('Last-Modified');
                const content = await response.text();

                // 更新状态
                appState.lastETag = eTag;
                appState.lastModified = lastModified;
                appState.lastContent = content;

                return {
                    status: 'success',
                    content,
                    isModified: true,
                    eTag,
                    lastModified
                };
            } finally {
                appState.isFetching = false;
            }
        }

        // 内容加载逻辑
        async function loadRecommendation() {
            const indicator = document.getElementById('updateIndicator');
            indicator.textContent = '检查中...';
            indicator.className = 'update-indicator';

            try {
                const result = await fetchContent();
                const contentDiv = document.getElementById('dailyRecommendation');
                const timeDiv = document.getElementById('updateTime');

                if (result.status === 'cached') {
                    contentDiv.textContent = appState.lastContent;
                    indicator.textContent = '已缓存';
                    indicator.className = 'update-indicator cached-data';
                } else {
                    contentDiv.textContent = result.content;
                    timeDiv.textContent = `最后更新: ${new Date().toLocaleString()}`;
                    
                    if (result.isModified) {
                        indicator.textContent = '最新内容';
                        indicator.className = 'update-indicator new-update';
                        // 5秒后恢复普通状态
                        setTimeout(() => {
                            indicator.textContent = '';
                        }, 5000);
                    }
                }

                // 存储到缓存
                if (CONFIG.cache.enabled && result.content) {
                    localStorage.setItem('appCache', JSON.stringify({
                        content: result.content,
                        timestamp: Date.now(),
                        eTag: result.eTag,
                        lastModified: result.lastModified
                    }));
                }
            } catch (error) {
                console.error('加载失败:', error);
                showError(error.message);
            }
        }

        // 自动更新检查
        function startUpdateChecker() {
            setInterval(async () => {
                try {
                    const result = await fetchContent();
                    const indicator = document.getElementById('updateIndicator');
                    
                    if (result.isModified) {
                        indicator.textContent = '有更新';
                        indicator.className = 'update-indicator new-update';
                    }
                } catch (error) {
                    console.log('更新检查失败:', error);
                }
            }, CONFIG.updateCheck.interval);
        }

        // 初始化加载
        function initialize() {
            // 尝试从缓存加载
            const cached = localStorage.getItem('appCache');
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    if (Date.now() - data.timestamp < CONFIG.cache.duration) {
                        const contentDiv = document.getElementById('dailyRecommendation');
                        contentDiv.textContent = data.content;
                        document.getElementById('updateTime').textContent = 
                            `最后更新: ${new Date(data.timestamp).toLocaleString()}`;
                        document.getElementById('recommendationSection').style.display = 'block';
                        
                        appState.lastContent = data.content;
                        appState.lastETag = data.eTag;
                        appState.lastModified = data.lastModified;
                    }
                } catch (e) {
                    console.log('缓存解析失败:', e);
                }
            }
            
            // 启动后台更新检查
            startUpdateChecker();
            
            // 立即检查更新（静默）
            setTimeout(() => {
                fetchContent().catch(console.error);
            }, 2000);
        }

        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
